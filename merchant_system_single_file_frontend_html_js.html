<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MerchantSystem — Admin & User Demo</title>
  <style>
    body{font-family: -apple-system,BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:20px; background:#f5f7fb}
    .container{max-width:1000px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .card{background:#fafbfd;padding:14px;border-radius:8px;border:1px solid #eef2fb}
    label{display:block;margin:6px 0 4px;font-size:13px}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #dfe8fb;background:#fff}
    button{padding:8px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .muted{color:#6b7280;font-size:13px}
    .row{display:flex;gap:8px}
    .small{font-size:12px;padding:6px 8px}
    pre{background:#0b1220;color:#dbeafe;padding:10px;border-radius:6px;max-height:220px;overflow:auto}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tabs button{background:#eef2ff;color:#0b1220;border:1px solid transparent}
    .tabs button.active{background:#2563eb;color:#fff}
    .wide{grid-column:1 / -1}
    .footer{margin-top:12px;font-size:13px;color:#4b5563}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MerchantSystem — Admin & User 前端演示</h1>
      <div class="muted">与 Postman collection 对应的快速操作页面</div>
    </header>

    <div class="tabs">
      <button id="tab-admin" class="active">Admin</button>
      <button id="tab-user">User</button>
    </div>

    <div id="content">
      <!-- ADMIN AREA -->
      <div id="admin-area" class="grid">
        <div class="card">
          <h3>Admin Login</h3>
          <label>Username</label>
          <input id="admin-username" value="admin1" />
          <label>Password</label>
          <input id="admin-password" type="password" value="123456" />
          <div style="margin-top:8px" class="row">
            <button onclick="adminLogin()">Login (POST /auth/login)</button>
            <button onclick="clearAdminToken()" class="small">Clear token</button>
          </div>
          <p class="muted">Admin token: <span id="admin-token-display">(empty)</span></p>
        </div>

        <div class="card">
          <h3>Create Merchant</h3>
          <label>Name</label>
          <input id="merchant-name" value="MerchantUnique001" />
          <label>Logo URL</label>
          <input id="merchant-logo" value="http://example.com/logo.png" />
          <label>Business License URL</label>
          <input id="merchant-license" value="http://example.com/license.png" />
          <label>Phone</label>
          <input id="merchant-phone" value="1234567890" />
          <label>Address</label>
          <input id="merchant-address" value="123 Main St" />
          <label>isAudit</label>
          <select id="merchant-isaudit"><option value="false">false</option><option value="true">true</option></select>
          <div style="margin-top:8px" class="row">
            <button onclick="createMerchant()">Create Merchant (POST /api/merchants)</button>
            <button onclick="getMerchantInfo()" class="small">Get Merchant (GET /api/merchants/{{merchant_id}})</button>
            <button onclick="auditMerchant(true)" class="small">Audit Pass (PUT /audit?pass=true)</button>
          </div>
          <p class="muted">Merchant ID: <span id="merchant-id-display">(empty)</span></p>
        </div>

        <div class="card">
          <h3>Create Product</h3>
          <label>Name</label>
          <input id="product-name" value="Product001" />
          <label>Price</label>
          <input id="product-price" value="99.9" />
          <label>Stock</label>
          <input id="product-stock" value="50" />
          <label>isActive</label>
          <select id="product-active"><option value="true">true</option><option value="false">false</option></select>
          <div style="margin-top:8px" class="row">
            <button onclick="createProduct()">Create Product (POST /api/products)</button>
            <button onclick="listActiveProducts()" class="small">List Products (GET /api/products)</button>
          </div>
          <p class="muted">Product ID: <span id="product-id-display">(empty)</span></p>
        </div>

        <div class="card wide">
          <h3>Raw Response / Console</h3>
          <pre id="log" aria-live="polite">欢迎 — 操作结果与请求日志会显示在这里。</pre>
        </div>
      </div>

      <!-- USER AREA -->
      <div id="user-area" class="grid" style="display:none">
        <div class="card">
          <h3>User Login</h3>
          <label>Username</label>
          <input id="user-username" value="user1" />
          <label>Password</label>
          <input id="user-password" type="password" value="123456" />
          <div style="margin-top:8px" class="row">
            <button onclick="userLogin()">Login (POST /auth/login)</button>
            <button onclick="clearUserToken()" class="small">Clear token</button>
          </div>
          <p class="muted">User token: <span id="user-token-display">(empty)</span></p>
        </div>

        <div class="card">
          <h3>Browse Products (User)</h3>
          <div style="margin-top:8px" class="row">
            <button onclick="listUserProducts()">List Products (GET /api/products)</button>
          </div>
          <div style="margin-top:8px">
            <label>User ID (用于创建订单)</label>
            <input id="order-userid" value="1" />
            <label>Product ID</label>
            <input id="order-productid" placeholder="从上面创建的 Product ID 填入" />
            <label>Quantity</label>
            <input id="order-quantity" value="1" />
            <label>Price</label>
            <input id="order-price" value="99.9" />
            <div style="margin-top:8px" class="row">
              <button onclick="createOrder()">Create Order (POST /api/orders)</button>
            </div>
            <p class="muted">Order ID: <span id="order-id-display">(empty)</span></p>
          </div>
        </div>

        <div class="card wide">
          <h3>Raw Response / Console (User)</h3>
          <pre id="log-user">用户操作日志会显示在这里。</pre>
        </div>
      </div>
    </div>

    <div class="footer">说明：默认使用 <code>http://localhost:8080</code>，如果你的后端地址不同，请修改 JS 中的 <code>BASE_URL</code>。</div>
  </div>

  <script>
    // 基础配置（如需更改后端地址请修改这里）
    const BASE_URL = 'http://localhost:8080';

    // DOM 缓存
    const log = document.getElementById('log');
    const logUser = document.getElementById('log-user');

    // tokens & ids 存储于 localStorage，方便多次刷新测试
    function saveAdminToken(t){ localStorage.setItem('admin_token', t); document.getElementById('admin-token-display').textContent = t || '(empty)'; }
    function saveUserToken(t){ localStorage.setItem('user_token', t); document.getElementById('user-token-display').textContent = t || '(empty)'; }
    function saveMerchantId(id){ localStorage.setItem('merchant_id', id); document.getElementById('merchant-id-display').textContent = id || '(empty)'; }
    function saveProductId(id){ localStorage.setItem('product_id', id); document.getElementById('product-id-display').textContent = id || '(empty)'; }
    function saveOrderId(id){ localStorage.setItem('order_id', id); document.getElementById('order-id-display').textContent = id || '(empty)'; }

    // 初始化显示
    document.getElementById('admin-token-display').textContent = localStorage.getItem('admin_token') || '(empty)';
    document.getElementById('user-token-display').textContent = localStorage.getItem('user_token') || '(empty)';
    document.getElementById('merchant-id-display').textContent = localStorage.getItem('merchant_id') || '(empty)';
    document.getElementById('product-id-display').textContent = localStorage.getItem('product_id') || '(empty)';
    document.getElementById('order-id-display').textContent = localStorage.getItem('order_id') || '(empty)';

    // TAB 切换
    document.getElementById('tab-admin').addEventListener('click', ()=>{ document.getElementById('admin-area').style.display='grid'; document.getElementById('user-area').style.display='none'; document.getElementById('tab-admin').classList.add('active'); document.getElementById('tab-user').classList.remove('active'); });
    document.getElementById('tab-user').addEventListener('click', ()=>{ document.getElementById('admin-area').style.display='none'; document.getElementById('user-area').style.display='grid'; document.getElementById('tab-admin').classList.remove('active'); document.getElementById('tab-user').classList.add('active'); });

    // 帮助函数：通用 fetch
    async function doFetch(path, method='GET', body=null, token=null){
      const headers = {};
      if (body && !(body instanceof FormData)) { headers['Content-Type'] = 'application/json'; }
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const opts = { method, headers };
      if (body) opts.body = (body instanceof FormData) ? body : JSON.stringify(body);
      const res = await fetch(BASE_URL + path, opts);
      const text = await res.text();
      // 尝试解析 JSON
      let json = null;
      try { json = JSON.parse(text); } catch(e){ json = text; }
      return { ok: res.ok, status: res.status, data: json, raw: text };
    }

    // Admin 登录
    async function adminLogin(){
      const u = document.getElementById('admin-username').value;
      const p = document.getElementById('admin-password').value;
      const r = await doFetch('/auth/login', 'POST', { username: u, password: p });
      appendLog('Admin Login', r);
      if (r.ok && r.data && r.data.token){ saveAdminToken(r.data.token); }
    }
    function clearAdminToken(){ localStorage.removeItem('admin_token'); saveAdminToken(''); appendLog('Admin token cleared'); }

    // Create Merchant
    async function createMerchant(){
      const token = localStorage.getItem('admin_token');
      if(!token){ appendLog('Create Merchant failed: admin_token missing'); return; }
      const body = {
        name: document.getElementById('merchant-name').value,
        logoUrl: document.getElementById('merchant-logo').value,
        businessLicenseUrl: document.getElementById('merchant-license').value,
        phone: document.getElementById('merchant-phone').value,
        address: document.getElementById('merchant-address').value,
        isAudit: document.getElementById('merchant-isaudit').value === 'true'
      };
      const r = await doFetch('/api/merchants', 'POST', body, token);
      appendLog('Create Merchant', r);
      if (r.ok && r.data && r.data.id){ saveMerchantId(r.data.id); }
    }

    // Get Merchant Info
    async function getMerchantInfo(){
      const token = localStorage.getItem('admin_token');
      const id = localStorage.getItem('merchant_id');
      if(!token || !id){ appendLog('Get Merchant Info failed: token or merchant_id missing'); return; }
      const r = await doFetch(`/api/merchants/${id}`, 'GET', null, token);
      appendLog('Get Merchant Info', r);
    }

    // Audit Merchant
    async function auditMerchant(pass=true){
      const token = localStorage.getItem('admin_token');
      const id = localStorage.getItem('merchant_id');
      if(!token || !id){ appendLog('Audit Merchant failed: token or merchant_id missing'); return; }
      const r = await doFetch(`/api/merchants/${id}/audit?pass=${pass}`, 'PUT', null, token);
      appendLog('Audit Merchant', r);
    }

    // Create Product
    async function createProduct(){
      const token = localStorage.getItem('admin_token');
      if(!token){ appendLog('Create Product failed: admin_token missing'); return; }
      const body = {
        name: document.getElementById('product-name').value,
        price: parseFloat(document.getElementById('product-price').value)||0,
        stock: parseInt(document.getElementById('product-stock').value)||0,
        isActive: document.getElementById('product-active').value === 'true'
      };
      const r = await doFetch('/api/products', 'POST', body, token);
      appendLog('Create Product', r);
      if (r.ok && r.data && r.data.id){ saveProductId(r.data.id); }
    }

    // List Active Products (Admin)
    async function listActiveProducts(){
      const token = localStorage.getItem('admin_token');
      if(!token){ appendLog('List Products failed: admin_token missing'); return; }
      const r = await doFetch('/api/products', 'GET', null, token);
      appendLog('List Products (admin)', r);
    }

    // User 登录
    async function userLogin(){
      const u = document.getElementById('user-username').value;
      const p = document.getElementById('user-password').value;
      const r = await doFetch('/auth/login', 'POST', { username: u, password: p });
      appendUserLog('User Login', r);
      if (r.ok && r.data && r.data.token){ saveUserToken(r.data.token); }
    }
    function clearUserToken(){ localStorage.removeItem('user_token'); saveUserToken(''); appendUserLog('User token cleared'); }

    // List Products (User)
    async function listUserProducts(){
      const token = localStorage.getItem('user_token');
      const r = await doFetch('/api/products', 'GET', null, token);
      appendUserLog('List Products (user)', r);
      // 如果数据里有产品 id，自动填充到订单表单以方便演示
      if (r.ok && Array.isArray(r.data) && r.data.length>0){ document.getElementById('order-productid').value = r.data[0].id || r.data[0].ID || '' }
    }

    // Create Order (User)
    async function createOrder(){
      const token = localStorage.getItem('user_token');
      if(!token){ appendUserLog('Create Order failed: user_token missing'); return; }
      const body = {
        userId: parseInt(document.getElementById('order-userid').value) || 1,
        total: parseFloat(document.getElementById('order-price').value) * (parseInt(document.getElementById('order-quantity').value)||1),
        items: [{ productId: parseInt(document.getElementById('order-productid').value)||parseInt(localStorage.getItem('product_id'))||0,
                  quantity: parseInt(document.getElementById('order-quantity').value)||1,
                  price: parseFloat(document.getElementById('order-price').value)||0 }]
      };
      const r = await doFetch('/api/orders', 'POST', body, token);
      appendUserLog('Create Order', r);
      if (r.ok && r.data && r.data.id){ saveOrderId(r.data.id); }
    }

    // 日志工具
    function appendLog(title, res){
      const when = new Date().toLocaleString();
      const t = `[${when}] ${title} — status:${res.status} ok:${res.ok}\n${JSON.stringify(res.data, null, 2)}\n\n`;
      log.textContent = t + log.textContent;
      console.log(title, res);
    }
    function appendLog(msg){
      const when = new Date().toLocaleString();
      log.textContent = `[${when}] ${msg}\n` + log.textContent;
    }
    function appendUserLog(title, res){
      const when = new Date().toLocaleString();
      const t = `[${when}] ${title} — status:${res.status} ok:${res.ok}\n${JSON.stringify(res.data, null, 2)}\n\n`;
      logUser.textContent = t + logUser.textContent;
      console.log(title, res);
    }
    function appendUserLog(msg){ const when = new Date().toLocaleString(); logUser.textContent = `[${when}] ${msg}\n` + logUser.textContent; }

    // 辅助：在加载时把 localStorage 的 token/id 展示出来
    (function(){ document.getElementById('admin-token-display').textContent = localStorage.getItem('admin_token') || '(empty)'; document.getElementById('user-token-display').textContent = localStorage.getItem('user_token') || '(empty)'; })();

  </script>
</body>
</html>